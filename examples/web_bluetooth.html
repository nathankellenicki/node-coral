<!DOCTYPE html>
<html>

<head>
  <title>Web Bluetooth node-coral Example</title>
  <link rel="stylesheet" type="text/css" href="./web_bluetooth.css" />

  <script src="../dist/web/coral.min.js"></script>

  <script>
    const { Coral, SingleMotorDevice, ColorSensorDevice, LegoColor, CoralDeviceKind } = window.NodeCoral;

    const logEl = document.getElementById("log");
    const scanButton = document.getElementById("scan");
    const colorEl = document.getElementById("color");

    const coral = new Coral();

    coral.on("discover", async (device) => {

      // If a SingleMotorDevice was found, start the motor going back and forth
      if (device instanceof SingleMotorDevice) {
        log(
          `Discovered ${device.info.name ?? "n/a"} / ${device.info.uuid} (color=${device.info.color ?? "n/a"} tag=${device.info.tag ?? "n/a"})`
        );
        renderHub(device);
        await device.connect();
        while (true) {
          await device.setMotorSpeed(50);
          await device.runMotorForDegrees(720, "Cw");
          await device.runMotorForDegrees(720, "Ccw");
        }

      // If a ColorSensorDevice was found, print the colors that are seen
      } else if (device instanceof ColorSensorDevice) {
        log(`Discovered color sensor ${device.info.name ?? "n/a"} / ${device.info.uuid}`);
        renderHub(device);
        await device.connect();
        device.on("color", (payload) => {
          const colorName = LegoColor[payload.color] ?? "None";
          log(`Color detected: id=${payload.color} (${colorName}) reflection=${payload.reflection}`);
          if (colorEl) {
            colorEl.style.backgroundColor = colorName === "None" ? "transparent" : colorName.toLowerCase();
          }
        });
      }
    });

    const renderHub = function (hub) {
      const deviceType = CoralDeviceKind[hub.kind] ?? "UnknownDevice";
      const element = document.createElement("tr");
      element.setAttribute("id", `hub-${encodeURIComponent(hub.info.uuid)}`);
      element.innerHTML = `<td>${hub.info.name}</td><td>${deviceType}</td><td class="disconnect_btn"><a href="#" onclick="disconnect('${encodeURIComponent(hub.info.uuid)}');">Disconnect</a></td>`;
      document.getElementById("hubs").appendChild(element);
    }

    const disconnect = async function (uuid) {
      const hub = coral.getHub(decodeURIComponent(uuid));
      if (hub) {
        await hub.disconnect();
        const element = document.getElementById(`hub-${encodeURIComponent(hub.info.uuid)}`);
        if (element) {
          element.remove();
        }
        log(`Disconnected from hub ${hub.info.name ?? "n/a"} / ${hub.info.uuid}`);
      }
    }

    const scan = function () {
      if (Coral.isWebBluetooth) {
        log("Scanning for Coral devices...");
        coral.scan(); // Start scanning for hubs
      } else {
        alert("Your browser does not support the Web Bluetooth specification.");
      }
    }

    const log = function (str) {
      const element = document.getElementById("console");
      element.innerHTML += `${str}<br />`;
      element.scrollTop = element.scrollHeight;
    }

  </script>
</head>

<body>
  <div>
    <h1>Web Bluetooth node-coral Example</h1>
  </div>
  <div>
    <a class="button" href="#" onclick="scan();">Add new Hub</a>
  </div>
  <div id="current_color">
    <span>Current Color: </span>
    <div id="color">&nbsp;</div>
  </div>
  <div>
    <table id="hubs">
      <thead class="headings">
        <td>Name</td>
        <td>Type</td>
      </thead>
    </table>
  </div>
  <div id="console"></div>
</body>

</html>
